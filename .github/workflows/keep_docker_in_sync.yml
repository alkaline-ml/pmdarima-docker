name: Keep Docker in Sync

on:
  schedule:
    - cron: '0 7 * * *'  # Every day at 07:00 UTC (1AM CST or 2AM CDT)

# Just for testing...
  push:
    branches:
      - '*'

jobs:
  keep-docker-in-sync:
    name: Check for Latest Version
    defaults:
      run:
        shell: bash
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master

      - name: Setting up Python
        uses: actions/setup-python@v1.1.1
        with:
          python-version: 3.8
          architecture: x64

      - name: Installing requirements
        run: pip install yolk3k requests

      - name: Find latest pmdarima version
        id: pypi_version_check  # Need this to refer to output below
        run: |
          output=($(yolk -V pmdarima))
          echo "::set-output name=pypi_version::${output[1]}"

      - name: Check if we already have this PR (open or closed)
        id: pr_check  # Need this to refer to output below
        run: |
          output=$(python .github/utils/bot_prs.py "Version ${{ steps.pypi_version_check.outputs.pypi_version }}")
          if [ $output == true ]; then
            echo "PR already exists for this version"
          fi
          echo "::set-output name=pr_exists::$output"

      - name: Find Docker version
        if: !steps.pr_check.outputs.pr_exists
        id: docker_version_check  # Need this to refer to output below
        run: |
          output=($(cat common/build.mk | grep "PMDARIMA_VSN :="))
          echo "::set-output name=docker_version::${output[2]}"

      - name: Update version in Docker
        if: steps.pypi_version_check.outputs.pypi_version != steps.docker_version_check.outputs.docker_version && !steps.pr_check.outputs.pr_exists
        run: sed -i "9s/.*/PMDARIMA_VSN := ${{ steps.pypi_version_check.outputs.pypi_version }}/" common/build.mk

      - name: Create Pull Request
        if: success() && steps.pypi_version_check.outputs.pypi_version != steps.docker_version_check.outputs.docker_version && !steps.pr_check.outputs.pr_exists
        uses: peter-evans/create-pull-request@v2
        with:
          token: ${{ secrets.TEST_TOKEN }}
          commit-message: Bump pmdarima version
          title: 'Version ${{ steps.pypi_version_check.outputs.pypi_version }}'
          body: |
            Bump docker version to ${{ steps.pypi_version_check.outputs.pypi_version }}

            Auto-generated by [create-pull-request][1]

            [1]: https://github.com/peter-evans/create-pull-request
          reviewers: tgsmith61591, charlesdrotar
          branch: version-${{ steps.pypi_version_check.outputs.pypi_version }}
          branch-suffix: random

      - name: Check outputs
        if: success() && steps.pypi_version_check.outputs.pypi_version != steps.docker_version_check.outputs.docker_version && !steps.pr_check.outputs.pr_exists
        run: echo "Pull Request Number - ${{ env.PULL_REQUEST_NUMBER }}"
